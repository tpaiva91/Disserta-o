\chapter{Análise de dados}\label{chap:dese}

Neste capítulo será discutido o que foi feito nesta dissertação. Serão abordados requisitos para realizar o trabalho, as decisões tomadas e respetiva explicação e as dificuldades encontradas, que levaram a eventuais alterações aos objetivos inicialmente propostos. Serão ainda mostrados os vários tipos de análises efetuadas aos dados recolhidos, bem como alguns resultados daí obtidos. 

\section{Descrição do estudo}

Para que este estudo pudesse ser feito, o primeiro passo era ter um conjunto de dados de pacientes diabéticos de forma a ser analisado. Este conjunto de dados tinha que ter algumas características específicas para que pudesse ser utilizado da forma pretendida: tinha que ser um conjunto de registos para cada paciente ao longo de algum tempo, sendo que idealmente, no mínimo, cada paciente teria registos correspondentes a quatro semanas. Depois de uma pesquisa, foi possível concluir que não existia, na \textit{web}, qualquer \textit{data set} com estas características.
Para que este estudo pudesse ser feito, era necessário ter um \textit{data set} com os diferentes parâmetros que pudessem ser relevantes, como glicemia, insulina, hidratos de carbono e exercício. 
Como já mencionado, nenhum \textit{data set} existente \textit{on-line} tinha as características desejadas pois só possuíam um registo por pessoa e/ou o seu propósito era a classificação de um paciente como diabético ou não. O único \textit{data set} encontrado que tinha vários registos por pessoa ao longo do tempo tinha o inconveniente de ter apenas dados relativos a glicemias.

Face à falta de dados disponíveis, a solução encontrada foi recolher, de raíz, os dados para a criação do \textit{data set} desejável. Ao podermos construir o nosso próprio \textit{data set} tínhamos a vantagem de podermos recolher as variáveis que queríamos, e portanto, ter um conjunto de dados que torne este trabalho mais eficiente. Por outro lado, visto que a recolha dos dados seria feita através da aplicação MyDiabetes, havia a desvantagem desta ser ainda fechada ao público e, portanto, não ter doentes diabéticos a utilizá-la. Uma outra desvantagem era o tempo que a criação de um \textit{data set} com a variedade e tamanho desejáveis poderia levar. Por variedade e tamanho desejáveis entenda-se dados relativos a cerca de 20 pessoas durante algumas semanas.

Feitas as contas, apesar das desvantagens enunciadas, a solução seria mesmo recolher os dados através da aplicação, sendo que o primeiro passo seria arranjar voluntários. O processo de recolha de dados é descrito na próxima secção.

\section{Recolha de dados}

A recolha de dados foi feita em parceria com o Hospital de S. João, através do seu serviço de endocrinologia. Para tal, foi pedido à comissão de ética autorização para falar com os pacientes diabéticos do hospital e para que estes utilizassem a aplicação, enviando os respetivos registos, pedido esse que foi aceite. Qualquer paciente seria elegível para o projeto desde que tivesse mais de 18 anos e fosse insulino-dependente. 

O Dr. Celestino Neves, médico endocrinologista daquele serviço, serviu de ponte entre a faculdade e o hospital. Nesta primeira fase, o Dr. Celestino dava uma pequena explicação do projeto ao paciente antes, durante ou depois da consulta, sendo que depois re-encaminhava o paciente para nós, investigadores. Esta primeira abordagem do Dr. Celestino era bastante importante uma vez que tornava os pacientes mais recetivos à participação. No nosso encontro com os pacientes, explicávamos o que era o projeto, mostrando no que a aplicação consistia e como funcionava. Depois desta parte, dávamos a conhecer ao paciente os passos seguintes, nomeadamente a integração de um sistema de conselhos baseados no \textit{input} do utilizador. Durante este processo, explicávamos ao paciente a importância de termos dados reais de utilizadores e portanto a importância do envio dos registos, realçando que a longo prazo, os utilizadores seriam os maiores beneficiados, pois poderiam melhorar o seu controlo da glicemia. Os pacientes eram ainda informados que os registos enviados seriam utilizados apenas para fins de investigação e que, caso aceitassem participar no projeto, teriam de assinar um consentimento informado que explicava isso mesmo.

Se os pacientes aceitassem fazer parte do projeto, a aplicação era então instalada nos seus \textit{smartphones} e seria-lhes também dado acesso à aplicação na \textit{Google Play}. Assim, a aplicação passaria a estar sempre disponível para esse utilizador, mesmo que este formatasse ou trocasse o telemóvel, a partir da loja. Outra vantagem deste acesso seria os utilizadores poderem usufruir das atualizações entretanto feitas: sempre que houvesse uma atualização, apareceria o aviso e o utilizador poderia atualizar sem perder os registos já feitos.

Além da aplicação, eram também dadas aos voluntários as credenciais para terem acesso ao \textit{website} do projeto, para onde poderiam exportar os registos efetuados e visualizá-los através de gráficos. As credenciais garantiam assim que apenas os voluntários tinham acesso à parte privada da página, que tem tutoriais e a parte de visualização dos dados.


\subsection{Números e \textit{feedback}}

Este processo era feito duas vezes por semana, que correspondia aos dias de consultas da diabetes, durante aproximadamente três meses. Durante este tempo falámos com várias dezenas de pacientes, sendo que foi possível obter, logo à partida, uma conclusão: a esmagadora maioria dos pacientes com quem falámos estavam bastante recetivos à ideia e concordavam que podia ser uma mais-valia na melhoria da sua qualidade de vida. Muito poucos pacientes tinham a opinião de que a aplicação não teria utilidade, principalmente devido ao facto de estes utilizarem bomba, que torna o processo de controlo da glicemia muito mais reduzido e simples.
Além da idea em si, que foi bastante bem recebida, os utilizadores também deram \textit{feedback} positivo relativamente ao \textit{design} e funcionalidades da aplicação. 

Apesar de todos os pacientes acharem boa ideia ter uma aplicação como esta, nem todos se tornaram voluntários devido a diferentes razões: 1) nem todos os utilizadores tinham \textit{smartphone} e cerca de metade dos pacientes tinha outro sistema operativo que não Android e 2) alguns pacientes com idade mais avançada ou com outros problemas de saúde simplesmente não tinham tempo ou não disponibilidade para participar como voluntário. 
No final deste período tínhamos conseguido a participação de 31 voluntários. Apesar de este número ser suficiente para o que se pretendia, pois inicialmente tinha sido definido como objetivo pelo menos 20 participantes, nem todos os voluntários enviaram, de facto, os registos. 
Dos 31 voluntários apenas 8 enviaram registos pelo menos uma vez e apenas 5 destes enviaram registos relativamente a algumas semanas. Isto foi um dos principais problemas encontrados: para integrar um sistema de aconselhamento baseado nos dados introduzidos numa aplicação para \textit{smartphone} é fundamental saber que tipo de avisos ou conselhos se deve ou não mostrar. Por exemplo, um conselho como "Ajuste a insulina à quantidade de hidratos de carbono ingerida" é algo óbvio e que qualquer paciente diabético sabe, e portanto não seria uma grande mais valia para a alicação. Por outro lado, um aviso como "Hoje é segunda-feira e geralmente à segunda-feira tem valores de glicemia mais elevados" pode ser útil porque possivelmente é um padrão que o paciente não detetou. Neste caso, este conselho poderia fazer o utilizador controlar mais frequentemente a sua glicemia às segundas-feiras e, portanto, normalizar os valores das segundas-feiras a partir daí. 

Esta distinção entre avisos ou conselhos realmente úteis ou descartáveis é importante: se a aplicação mostrar demasiados conselhos intuitivos ou regras "banais" das quais os utilizadores já tenham conhecimento, estes podem acabar por achar que a aplicação não traz benefícios. Pelo contrário, se a aplicação mostrar conselhos baseados em comportamentos errados para cada utilizador, estes podem aperceber-se de que realmente têm esses comportamentos errados e usufruir verdadeiramente deste sistema de aconselhamento. 

Para fazer esta distinção torna-se importante obter a maior quantidade e variedade possível de dados. Imaginemos que temos apenas um \textit{data set} de um paciente com registos de uma semana. Esta quantidade de dados não permite concluir nada sobre eventuais regras descobertas nem sequer permite descobrir vários tipos de regras; tanto a variedade de pacientes como a quantidade de registos serão demasiado reduzidas para tal. 

Da mesma forma, os registos de 5 pacientes, embora seja obviamente mais vantajoso do que o registo de apenas 1 paciente, não é suficiente para esta parte. Uma vez mais, 5 pacientes não oferecem muita quantidade nem variedade em relação a rotinas ou comportamentos errados, que se traduz na variedade de regras produzidas. 

O objetivo da aplicação é gerar os tais conselhos de forma automática e, pensado desta forma, esta parte inicial pode parecer inútil: para quê estar a gerar regras se elas não vão ser utilizadas na aplicação em si? 

Esta questão prende-se, uma vez mais, com a filtragem de regras úteis ou não. Os registos de um único paciente podem gerar, por exemplo, centenas ou até milhares de regras. Obviamente que em milhares de regras muitas vão ser bastante parecidas e a esmagadora maioria vão ser regras que não têm relevância. É possível, por exemplo, que em alguns milhares de regras só se consiga aproveitar 5 ou 6. A importância de ter registos de vários pacientes prende-se com a variedade das regras geradas: dois pacientes podem gerar poucas regras cada um mas essas regras serem diferentes, ou seja, relativas a rotinas ou anomalias com efeitos ou causas diferentes. Esta análise dos dados à procura de regras servirá, então, para construir um conjunto de regras passíveis de ocorrer no dia-a-dia de um diabético que serão então integradas nesta aplicação. Assim, serão apenas detetados padrões e situações que possam ter alguma relevância e conselhos como "Adeque a insulina aos hidratos de carbono" não serão mostrados. Isto porque apesar de ser um bom conselho, também é óbvio e portanto provavelmente será tido como um conselho inútil por parte dos utilizadores. 

Ao ter esta filtragem para mostrar apenas conselhos realmente importantes, não só diminuiremos a quantidade de vezes que algum conselho é mostrado, tornando assim a aplicação menos "chata" para os utilizadores, como também tornam os conselhos mais especiais, ou seja, se um conselho ou aviso é mostrado é porque o utilizador tem de facto algum comportamento errado e que pode ser corrigido.

Neste sentido, a pouca quantidade de voluntários que enviaram registos foi a primeira dificuldade encontrada e que nos fez alterar a estratégia: uma vez que os dados existentes não seriam suficientes para fazer o sistema de aconselhamento de uma forma tão fidedigna quanto desejável, esse objetivo foi posto de lado. Face a estas novas circunstâncias, o objetivo passou a ser analisar os dados existentes das mais variadas formas para ver que tipo de conclusões se consegue obter. Os diferentes tipos de análises feitas vão ser descritos ainda neste capítulo.

Apesar de os dados serem poucos, a parte positiva é que estavam no formato pretendido e portanto o passo seguinte era começar a tratá-los.


\subsection{O \textit{data set}}

Os registos dos utilizadores são armazenados no telemóvel numa base de dados \textit{sqlite}[sqlite] que é depois convertida para um ficheiro csv através de um \textit{script}. Os dados recebidos contêm alguns dados que são descartados, como os dados pessoais do utilizador, registo de peso ou medicação, que não são tão relevantes para a análise. Mesmo relativamente a algumas variáveis, como a glicemia por exemplo, só nos interessa saber o valor e a hora, e portanto todos os outros dados sobre a glicemia são apagados, como o "ID", "Tag" que é um valor opcional que pode associar a medição a um evento, como "pequeno-almoço" e "Note" que associa uma nota à medição. O mesmo é feito para as outras variáveis. Um \textit{data set} no estado inicial em formato csv tem a seguinte estrutura:

\begin{table}[!h]
\centering

\label{my-label}
\tabcolsep=0.11cm
\begin{tabular}{|l|l|l|l|l|l|l|l|}
\hline
\textbf{Nome} & DateTime  & Value\_Carbs & Value\_Glucose & Value\_Insulin & Exercise \\ \hline
\textbf{Tipo} & integer   & integer      & integer        & double         & double   \\ \hline
\end{tabular}
\caption{\textit{Data set} original}
\end{table}

O \textbf{DateTime} diz respeito ao dia e hora exatos de cada registo;
\textbf{Value\textunderscore Carbs} é a quantidade de hidratos de carbono;
\textbf{Value\textunderscore Glucose} é o nível de glicemia à hora do registo;
\textbf{Value\textunderscore Insulin} é a quantidade de insulina tomada pelo utilizador à hora do registo;
\textbf{Exercise} corresponde ao exercício feito à hora do registo.

No entanto, os dados não estavam ainda prontos a ser utilizados e precisavam de ser pré-processados.

\subsection{Pré-processamento dos dados}

Uma parte crucial de \textit{data mining}, ainda antes de aplicar quaisquer técnicas, é a parte de pré-processamento dos dados. Esta parte é composta por várias etapas:

\begin{itemize}
\item Limpeza dos dados
\item Redução dos dados
\item Transformação dos dados
\end{itemize}
 
O pré-processamento dos dados é necessário para tratar inconsistências que possam existir no \textit{data set}. Estas inconsistências podem ser valores em falta ou valores errados. Por exemplo, num \textit{data set} com um campo "Idade", um valor negativo neste campo é um valor errado. Então, para chegar a um estado em que o \textit{data set} esteja pronto a ser utilizado, é preciso percorrer um ou mais dos passos acima mencionados. 

\textbf{Limpeza dos dados} - é o primeiro passo a fazer num conjunto de dados. Neste caso específico, o \textit{data set} vinha com alguns valores em falta ou valores errados. Apesar destes casos serem uma percentagem pequena do total, é importante que sejam resolvidos. Para valores em falta há duas opções: ou remover o registo em que um dos valores falte, ou tentar prever o falor em falta e preenchê-lo. A segunda opção pode ser feita obtendo, por exemplo, a média dessa variável e, em todos os registos com valor em falta, colocar a média. No entanto, para o caso específico da diabetes esta alternativa não parecia a mais viável. Por exemplo, se num dado registo faltar o valor da glicemia, não faz sentido encontrar a média da glicemia para todos os registos e colocar no registo em falta. A glicemia pode oscilar bastante e portanto, estar a preencher um valor em falta com um valor médio da glicemia pode estar a comprometer a veracidade da análise posterior: um registo que até podia ter um valor de hiperglicemia estaria a ser substituído com um valor de glicemia mais normal e portanto, esse registo já não seria uma exceção. Repetindo isto para todos os valores de glicemia em falta, estaria-se a normalizar situações que podiam não ser normais. Posto isto, a alternativa tomada foi a de apagar todos os registos que tivessem valores de glicemia em falta ou valores anormais. Por exemplo, alguns registos tinham valores "0" ou "7", que não são valores realistas para glicemia e portanto trata-se um erro de registo. Assim garante-se que todos os registos tenham valores e que esses valores sejam valores realistas. Esta medida foi tomada apenas para as variáveis necessárias para análise, isto é, para uma análise apenas com a glicemia, as outras variáveis não são tidas em conta e portanto não são limpas. Já para uma análise de procura de regras, como todas as variáveis são utilizadas, todas as variáveis são limpas. 

Isto garante também que as regras geradas não são enviesadas: se quisermos descobrir regras que relacionem os valores de insulina e hidratos de carbono com os valores de glicemia, mas utilizarmos registos que tenham alguns valores de insulina ou hidratos de carbono a zero, então esses registos vão contribuir tanto como os outros para o resultado final, pelo que esse resultado poderá estar adulterado. Limpando um registo inteiro, qualquer que seja o valor da variável em falta ou com um valor errado, garantimos que qualquer resultado obtido numa análise será realista.


\textbf{Redução dos dados} - Num \textit{data set} nem todos os dados têm a mesma relevância: uns são importantes e outros são menos importantes ou até mesmo irrelevantes. É importante perceber quais os dados que não interessa ter, pois assim vamos reduzir a quantidade de regras irrelevantes que são geradas. Por isso mesmo, o segundo passo seria analisar todos os dados recolhidos e perceber quais os que valiam a pena manter e os que se podia remover. Um exemplo que ajuda a perceber melhor este passo é olharmos para os valores de glicose, insulina e hidratos de carbono: na aplicação, cada um destes parâmetros permite registar o valor em si mas também adicionar uma nota para acompanhar o registo. Essa nota poderá ser uma breve descrição feita pelo utilizador aquando de um registo. Existe também um outro atributo chamado "Tag" que permite, por exemplo, associar uma refeição a um período do dia. Se a "Tag" 1 for "pequeno-almoço", então sempre que o utilizador regista o pequeno-almoço, pode escolher essa fase do dia, e esse registo ficará com a "Tag" 1. Como se pode perceber, atributos como "Note" ou "Tag" podem ajudar a perceber o porquê de alguma alteração nos valores de glicose mas não têm qualquer uso para a descoberta de padrões e consequente geração de regras. Portanto, atributos como estes podem ser retirados do \textit{data set} de forma a reduzir a quantidade de informação não relevante. Existem outros atributos que foram retirados por não apresentarem qualquer utilidade para o resultado pretendido, tais como, "Idade", "Nome", "Altura" ou "Sexo". 
No final deste passo, o conjunto de dados é consideravelmente mais pequeno, em termos de quantidade de variáveis, e portanto permite fazer uma análise mais objetiva, com menos informação desinteressante.

\textbf{Transformação dos dados} - Por fim, este passo serve para transformar os valores existentes em valores que possam ser utilizados da forma mais conveniente. Ter uma variável "DateTime" no formato "AAAA-MM-DD HH:MM" não é tão útil visto que o dia e hora, que até podem ser variáveis interessantes, estão numa só variável e torna o seu uso mais difícil. Neste caso, seria mais vantajoso separar as duas variáveis e portanto, transformar "DateTime" em "Day" e "Hour". Ainda assim, ter um dia do ano e uma hora específica do dia não é exatamente o formato mais útil, pois são variáveis demasiado específicas e por isso pouco repetidas, ou até nunca repetidas, pelo que não irão contribuir para a descoberta de padrões. Para melhorar este detalhe, podia ainda fazer-se outra alteração: transformar o dia do ano em dias da semana e transformar a hora do dia em período do dia, como "manhã", "noite", ou "tarde". Assim, passámos da variável "DateTime" a duas variáveis, "Day" e "Period".

